<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mamba Agents - Code Map</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3344;
    --text: #e1e4ed;
    --text-dim: #8b90a0;
    --accent: #7c6ef6;
    --accent-dim: #5b4fd1;

    --core: #60a5fa;
    --core-bg: #1e3a5f;
    --infra: #34d399;
    --infra-bg: #1a3d2e;
    --tools: #fbbf24;
    --tools-bg: #3d3520;
    --orchestration: #f472b6;
    --orchestration-bg: #3d1a30;
    --integration: #a78bfa;
    --integration-bg: #2d1f4e;
    --observability: #fb923c;
    --observability-bg: #3d2a1a;
    --private: #6b7280;
    --private-bg: #252830;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ── HEADER ── */
  header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }
  header h1 {
    font-size: 15px;
    font-weight: 600;
    white-space: nowrap;
  }
  header h1 span { color: var(--accent); }

  .search-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    flex: 1;
    max-width: 340px;
  }
  .search-box svg { flex-shrink: 0; opacity: 0.5; }
  .search-box input {
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 13px;
    outline: none;
    width: 100%;
  }
  .search-box input::placeholder { color: var(--text-dim); }

  .view-tabs {
    display: flex;
    gap: 2px;
    background: var(--surface2);
    border-radius: 6px;
    padding: 2px;
  }
  .view-tab {
    padding: 5px 14px;
    border-radius: 5px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  .view-tab:hover { color: var(--text); }
  .view-tab.active { background: var(--accent); color: #fff; }

  .preset-btns {
    display: flex;
    gap: 4px;
    margin-left: auto;
  }
  .preset-btn {
    padding: 5px 12px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text-dim);
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .preset-btn:hover { border-color: var(--accent); color: var(--text); }
  .preset-btn.active { border-color: var(--accent); background: var(--accent-dim); color: #fff; }

  /* ── MAIN LAYOUT ── */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ── SIDEBAR ── */
  .sidebar {
    width: 280px;
    min-width: 280px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    background: var(--surface);
    overflow-y: auto;
  }
  .sidebar-section {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-section h3 {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 10px;
  }

  .layer-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    cursor: pointer;
    font-size: 12px;
  }
  .layer-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .layer-toggle input { display: none; }
  .layer-toggle .check-box {
    width: 14px;
    height: 14px;
    border: 1.5px solid var(--border);
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .layer-toggle input:checked + .check-box {
    background: var(--accent);
    border-color: var(--accent);
  }
  .layer-toggle input:checked + .check-box::after {
    content: '';
    width: 7px;
    height: 4px;
    border-left: 1.5px solid #fff;
    border-bottom: 1.5px solid #fff;
    transform: rotate(-45deg) translateY(-1px);
  }

  .conn-type {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    cursor: pointer;
    font-size: 12px;
  }
  .conn-line {
    width: 24px;
    height: 2px;
    flex-shrink: 0;
    border-radius: 1px;
  }
  .conn-line.dashed { background: repeating-linear-gradient(90deg, currentColor 0, currentColor 5px, transparent 5px, transparent 8px); height: 2px; }
  .conn-line.dotted { background: repeating-linear-gradient(90deg, currentColor 0, currentColor 2px, transparent 2px, transparent 5px); height: 2px; }

  /* ── DETAIL PANEL ── */
  .detail-panel {
    position: absolute;
    top: 0;
    right: 0;
    width: 340px;
    height: 100%;
    background: var(--surface);
    border-left: 1px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.2s ease;
    z-index: 20;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .detail-panel.open { transform: translateX(0); }

  .detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--surface);
  }
  .detail-header h2 { font-size: 14px; font-weight: 600; }
  .detail-close {
    background: transparent;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .detail-close:hover { background: var(--surface2); color: var(--text); }

  .detail-body { padding: 16px; }
  .detail-body .meta { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; font-family: 'SF Mono', 'Fira Code', monospace; }
  .detail-body .desc { font-size: 12px; line-height: 1.5; color: var(--text); margin-bottom: 16px; }

  .detail-section { margin-bottom: 16px; }
  .detail-section h4 {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .detail-item {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    margin-bottom: 2px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    background: var(--surface2);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .detail-item .kind {
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 3px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .kind-class { background: #3b82f622; color: #60a5fa; }
  .kind-func { background: #34d39922; color: #34d399; }
  .kind-file { background: #fbbf2422; color: #fbbf24; }
  .kind-const { background: #a78bfa22; color: #a78bfa; }
  .kind-error { background: #ef444422; color: #ef4444; }

  .dep-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--surface2);
    margin: 0 4px 4px 0;
    cursor: pointer;
    transition: background 0.15s;
  }
  .dep-link:hover { background: var(--accent-dim); }

  /* ── COMMENT AREA ── */
  .comment-area {
    padding: 16px;
    border-top: 1px solid var(--border);
  }
  .comment-area h4 {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .comment-input {
    display: flex;
    gap: 6px;
  }
  .comment-input textarea {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px;
    font-size: 12px;
    font-family: inherit;
    resize: vertical;
    min-height: 60px;
    outline: none;
  }
  .comment-input textarea:focus { border-color: var(--accent); }
  .comment-add-btn {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    background: var(--accent);
    color: #fff;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    align-self: flex-end;
  }
  .comment-add-btn:hover { background: var(--accent-dim); }

  /* ── COMMENTS LIST (sidebar) ── */
  .comments-list { padding: 0; }
  .comment-entry {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  .comment-entry .ce-target { font-weight: 600; color: var(--accent); margin-bottom: 2px; }
  .comment-entry .ce-text { color: var(--text-dim); line-height: 1.4; }
  .comment-entry .ce-del {
    background: none;
    border: none;
    color: #ef4444;
    font-size: 11px;
    cursor: pointer;
    float: right;
    opacity: 0.6;
  }
  .comment-entry .ce-del:hover { opacity: 1; }
  .no-comments { padding: 16px; font-size: 12px; color: var(--text-dim); text-align: center; }

  /* ── CANVAS AREA ── */
  .canvas-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
  }
  .canvas-wrap svg {
    width: 100%;
    height: 100%;
    cursor: grab;
  }
  .canvas-wrap svg:active { cursor: grabbing; }

  .zoom-controls {
    position: absolute;
    bottom: 14px;
    left: 14px;
    display: flex;
    gap: 4px;
    z-index: 10;
  }
  .zoom-btn {
    width: 32px;
    height: 32px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface);
    color: var(--text);
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
  }
  .zoom-btn:hover { background: var(--surface2); border-color: var(--accent); }

  .stats-bar {
    position: absolute;
    bottom: 14px;
    right: 14px;
    display: flex;
    gap: 12px;
    font-size: 11px;
    color: var(--text-dim);
    background: var(--surface);
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    z-index: 10;
  }
  .stats-bar span strong { color: var(--text); }

  /* ── PROMPT OUTPUT ── */
  .prompt-bar {
    border-top: 1px solid var(--border);
    background: var(--surface);
    padding: 10px 20px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    flex-shrink: 0;
    max-height: 140px;
    overflow-y: auto;
  }
  .prompt-bar .prompt-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    white-space: nowrap;
    padding-top: 3px;
  }
  .prompt-text {
    flex: 1;
    font-size: 12px;
    line-height: 1.5;
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', monospace;
    white-space: pre-wrap;
  }
  .copy-btn {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .copy-btn:hover { border-color: var(--accent); }
  .copy-btn.copied { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* ── LIST VIEW ── */
  .list-view {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .list-view.active { display: block; }
  .list-module {
    margin-bottom: 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    background: var(--surface);
  }
  .list-module-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .list-module-header:hover { background: var(--surface2); }
  .list-module-header .lm-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .list-module-header .lm-name { font-weight: 600; font-size: 14px; }
  .list-module-header .lm-cat { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-left: auto; }
  .list-module-body {
    display: none;
    padding: 0 16px 12px;
    border-top: 1px solid var(--border);
  }
  .list-module-body.open { display: block; padding-top: 12px; }
  .list-module-body .lm-desc { font-size: 12px; color: var(--text-dim); margin-bottom: 10px; line-height: 1.5; }
  .list-module-body .lm-files { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
  .list-module-body .lm-file {
    font-size: 11px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    padding: 2px 8px;
    border-radius: 4px;
    background: var(--surface2);
    color: var(--text-dim);
  }
  .list-module-body .lm-exports { margin-top: 8px; }
  .list-module-body .lm-export-item {
    font-size: 11px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--surface2);
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ── SVG NODE STYLES ── */
  .node-group { cursor: pointer; }
  .node-group:hover .node-rect { filter: brightness(1.2); }
  .node-rect { transition: filter 0.15s, stroke 0.15s; }
  .node-rect.selected { stroke-width: 2.5; }
  .node-rect.commented { stroke-dasharray: none; }
  .node-rect.search-match { stroke: #fbbf24 !important; stroke-width: 2.5; }
  .node-label { pointer-events: none; }
  .node-sub { pointer-events: none; }
  .conn-path { pointer-events: none; fill: none; stroke-width: 1.5; }
  .conn-path.highlight { stroke-width: 2.5; opacity: 1 !important; }

  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <h1><span>Mamba Agents</span> Code Map</h1>
  <div class="search-box">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
    <input id="search" type="text" placeholder="Search modules, classes, files..." autocomplete="off">
  </div>
  <div class="view-tabs">
    <button class="view-tab active" data-view="graph">Graph</button>
    <button class="view-tab" data-view="list">List</button>
  </div>
  <div class="preset-btns">
    <button class="preset-btn active" data-preset="full">Full System</button>
    <button class="preset-btn" data-preset="core">Core Flow</button>
    <button class="preset-btn" data-preset="infra">Infrastructure</button>
    <button class="preset-btn" data-preset="agent">Agent Stack</button>
  </div>
</header>

<div class="main">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section">
      <h3>Layers</h3>
      <div id="layer-toggles"></div>
    </div>
    <div class="sidebar-section">
      <h3>Connections</h3>
      <div id="conn-toggles"></div>
    </div>
    <div class="sidebar-section">
      <h3>Comments <span id="comment-count">(0)</span></h3>
      <div id="comments-list" class="comments-list">
        <div class="no-comments">Click a module to add feedback</div>
      </div>
    </div>
  </div>

  <!-- CANVAS -->
  <div class="canvas-wrap" id="canvas-wrap">
    <svg id="svg" xmlns="http://www.w3.org/2000/svg"></svg>
    <div class="detail-panel" id="detail-panel">
      <div class="detail-header">
        <h2 id="detail-title">Module</h2>
        <button class="detail-close" id="detail-close">&times;</button>
      </div>
      <div class="detail-body" id="detail-body"></div>
      <div class="comment-area">
        <h4>Add Comment</h4>
        <div class="comment-input">
          <textarea id="comment-text" placeholder="Your feedback on this module..."></textarea>
          <button class="comment-add-btn" id="comment-add">Add</button>
        </div>
      </div>
    </div>
    <div class="zoom-controls">
      <button class="zoom-btn" id="zoom-in">+</button>
      <button class="zoom-btn" id="zoom-out">&minus;</button>
      <button class="zoom-btn" id="zoom-reset" style="font-size:11px">Fit</button>
    </div>
    <div class="stats-bar" id="stats-bar">
      <span>Modules: <strong id="stat-modules">0</strong></span>
      <span>Connections: <strong id="stat-conns">0</strong></span>
      <span>LOC: <strong>~10,949</strong></span>
    </div>
  </div>

  <!-- LIST VIEW -->
  <div class="list-view" id="list-view"></div>
</div>

<!-- PROMPT BAR -->
<div class="prompt-bar">
  <span class="prompt-label">Prompt</span>
  <div class="prompt-text" id="prompt-text">Explore the Mamba Agents architecture by clicking modules, toggling layers, and adding comments.</div>
  <button class="copy-btn" id="copy-btn">Copy</button>
</div>

<script>
// ═══════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════

const CATEGORIES = {
  core:           { label: 'Core',           color: '#60a5fa', bg: '#1e3a5f' },
  infrastructure: { label: 'Infrastructure', color: '#34d399', bg: '#1a3d2e' },
  tools:          { label: 'Tools',          color: '#fbbf24', bg: '#3d3520' },
  orchestration:  { label: 'Orchestration',  color: '#f472b6', bg: '#3d1a30' },
  integration:    { label: 'Integration',    color: '#a78bfa', bg: '#2d1f4e' },
  observability:  { label: 'Observability',  color: '#fb923c', bg: '#3d2a1a' },
  private:        { label: 'Private',        color: '#6b7280', bg: '#252830' },
};

const CONN_TYPES = {
  'imports':    { label: 'Imports',      color: '#6b7280', dash: '4,3' },
  'integrates': { label: 'Integrates',   color: '#60a5fa', dash: '' },
  'configures': { label: 'Configures',   color: '#34d399', dash: '6,3' },
  'uses':       { label: 'Uses',         color: '#fbbf24', dash: '8,4' },
  'extends':    { label: 'Extends',      color: '#f472b6', dash: '' },
};

const modules = [
  {
    id: 'agent', label: 'Agent', subtitle: 'agent/',
    category: 'core', x: 540, y: 60, w: 160, h: 56,
    description: 'Core agent abstraction wrapping pydantic-ai. Manages context tracking, token counting, and cost estimation. Entry point for all agent interactions.',
    files: ['core.py', 'config.py', 'result.py', 'message_utils.py'],
    exports: [
      { name: 'Agent', kind: 'class' },
      { name: 'AgentConfig', kind: 'class' },
      { name: 'AgentResult', kind: 'class' },
      { name: 'dicts_to_model_messages', kind: 'func' },
      { name: 'model_messages_to_dicts', kind: 'func' },
    ],
    deps: ['config', 'context', 'tokens', 'prompts', 'errors'],
  },
  {
    id: 'config', label: 'Config', subtitle: 'config/',
    category: 'infrastructure', x: 180, y: 60, w: 150, h: 56,
    description: 'Configuration management using pydantic-settings. Loads from env vars, .env files, TOML/YAML configs. Uses MAMBA_ prefix with nested __ separator.',
    files: ['settings.py', 'model_backend.py', 'logging_config.py', 'retry.py'],
    exports: [
      { name: 'AgentSettings', kind: 'class' },
      { name: 'ModelBackendSettings', kind: 'class' },
      { name: 'LoggingConfig', kind: 'class' },
      { name: 'ErrorRecoveryConfig', kind: 'class' },
    ],
    deps: ['context', 'tokens', 'prompts'],
  },
  {
    id: 'context', label: 'Context', subtitle: 'context/',
    category: 'infrastructure', x: 100, y: 210, w: 150, h: 56,
    description: 'Context window management and auto-compaction. 5 strategies: sliding_window, summarize_older, selective_pruning, importance_scoring, hybrid.',
    files: ['manager.py', 'config.py', 'history.py', 'compaction/base.py', 'compaction/sliding_window.py', 'compaction/summarize.py', 'compaction/selective.py', 'compaction/importance.py', 'compaction/hybrid.py'],
    exports: [
      { name: 'ContextManager', kind: 'class' },
      { name: 'CompactionConfig', kind: 'class' },
      { name: 'CompactionResult', kind: 'class' },
      { name: 'ContextState', kind: 'class' },
      { name: 'CompactionStrategy', kind: 'class' },
      { name: 'SlidingWindowStrategy', kind: 'class' },
      { name: 'SummarizeOlderStrategy', kind: 'class' },
      { name: 'HybridStrategy', kind: 'class' },
    ],
    deps: ['tokens'],
  },
  {
    id: 'tokens', label: 'Tokens', subtitle: 'tokens/',
    category: 'infrastructure', x: 330, y: 210, w: 150, h: 56,
    description: 'Token counting via tiktoken, usage tracking across requests, and cost estimation with model-specific rates.',
    files: ['counter.py', 'tracker.py', 'cost.py', 'config.py'],
    exports: [
      { name: 'TokenCounter', kind: 'class' },
      { name: 'UsageTracker', kind: 'class' },
      { name: 'CostEstimator', kind: 'class' },
      { name: 'TokenUsage', kind: 'class' },
      { name: 'UsageRecord', kind: 'class' },
      { name: 'CostBreakdown', kind: 'class' },
      { name: 'TokenizerConfig', kind: 'class' },
    ],
    deps: [],
  },
  {
    id: 'prompts', label: 'Prompts', subtitle: 'prompts/',
    category: 'infrastructure', x: 560, y: 210, w: 150, h: 56,
    description: 'Jinja2-based template system with Markdown support. File-based templates with inheritance, YAML frontmatter, and runtime registration.',
    files: ['manager.py', 'template.py', 'config.py', 'loader.py', 'markdown.py', 'errors.py'],
    exports: [
      { name: 'PromptManager', kind: 'class' },
      { name: 'PromptTemplate', kind: 'class' },
      { name: 'TemplateConfig', kind: 'class' },
      { name: 'PromptConfig', kind: 'class' },
      { name: 'TemplateType', kind: 'const' },
      { name: 'PromptError', kind: 'error' },
      { name: 'PromptNotFoundError', kind: 'error' },
      { name: 'TemplateRenderError', kind: 'error' },
    ],
    deps: [],
  },
  {
    id: 'tools', label: 'Tools', subtitle: 'tools/',
    category: 'tools', x: 900, y: 60, w: 150, h: 56,
    description: 'Built-in tools: filesystem ops (read, write, copy, move, delete), bash execution, glob search, grep search. Includes security boundaries.',
    files: ['base.py', 'registry.py', 'bash.py', 'glob.py', 'grep.py', 'filesystem/read.py', 'filesystem/write.py', 'filesystem/operations.py', 'filesystem/directory.py', 'filesystem/info.py', 'filesystem/security.py'],
    exports: [
      { name: 'read_file', kind: 'func' },
      { name: 'write_file', kind: 'func' },
      { name: 'run_bash', kind: 'func' },
      { name: 'glob_search', kind: 'func' },
      { name: 'grep_search', kind: 'func' },
      { name: 'ToolRegistry', kind: 'class' },
      { name: 'ToolConfig', kind: 'class' },
      { name: 'ToolResult', kind: 'class' },
      { name: 'FilesystemSecurity', kind: 'class' },
    ],
    deps: [],
  },
  {
    id: 'workflows', label: 'Workflows', subtitle: 'workflows/',
    category: 'orchestration', x: 780, y: 210, w: 160, h: 56,
    description: 'Multi-step orchestration: abstract Workflow base, ReAct implementation (Thought-Action-Observation loop), state tracking, hooks system.',
    files: ['base.py', 'config.py', 'errors.py', 'hooks.py', 'react/workflow.py', 'react/config.py', 'react/state.py', 'react/hooks.py', 'react/prompts.py', 'react/tools.py', 'react/termination.py'],
    exports: [
      { name: 'Workflow', kind: 'class' },
      { name: 'WorkflowConfig', kind: 'class' },
      { name: 'WorkflowHooks', kind: 'class' },
      { name: 'WorkflowResult', kind: 'class' },
      { name: 'WorkflowState', kind: 'class' },
      { name: 'ReActWorkflow', kind: 'class' },
      { name: 'ReActConfig', kind: 'class' },
      { name: 'ReActState', kind: 'class' },
      { name: 'ReActHooks', kind: 'class' },
      { name: 'ScratchpadEntry', kind: 'class' },
      { name: 'WorkflowError', kind: 'error' },
    ],
    deps: ['agent', 'prompts'],
  },
  {
    id: 'mcp', label: 'MCP', subtitle: 'mcp/',
    category: 'integration', x: 1020, y: 210, w: 150, h: 56,
    description: 'Model Context Protocol integration. Supports stdio, SSE, and Streamable HTTP transports. Load from .mcp.json files (Claude Desktop format).',
    files: ['client.py', 'config.py', 'auth.py', 'env.py', 'loader.py', 'errors.py'],
    exports: [
      { name: 'MCPClientManager', kind: 'class' },
      { name: 'MCPServerConfig', kind: 'class' },
      { name: 'MCPAuthConfig', kind: 'class' },
      { name: 'MCPConnectionResult', kind: 'class' },
      { name: 'MCPToolInfo', kind: 'class' },
      { name: 'load_mcp_json', kind: 'func' },
      { name: 'MCPConfigError', kind: 'error' },
      { name: 'MCPConnectionError', kind: 'error' },
    ],
    deps: [],
  },
  {
    id: 'errors', label: 'Errors', subtitle: 'errors/',
    category: 'infrastructure', x: 180, y: 370, w: 150, h: 56,
    description: 'Exception hierarchy, retry system with 3 recovery levels (conservative, balanced, aggressive), and circuit breaker pattern.',
    files: ['exceptions.py', 'retry.py', 'circuit_breaker.py'],
    exports: [
      { name: 'AgentError', kind: 'error' },
      { name: 'AuthenticationError', kind: 'error' },
      { name: 'ConfigurationError', kind: 'error' },
      { name: 'ModelBackendError', kind: 'error' },
      { name: 'RateLimitError', kind: 'error' },
      { name: 'CircuitBreaker', kind: 'class' },
      { name: 'RetryContext', kind: 'class' },
      { name: 'create_retry_decorator', kind: 'func' },
    ],
    deps: ['config'],
  },
  {
    id: 'backends', label: 'Backends', subtitle: 'backends/',
    category: 'infrastructure', x: 460, y: 370, w: 150, h: 56,
    description: 'OpenAI-compatible model backends. Factory helpers for Ollama, vLLM, LM Studio. Model profiles with context window and pricing info.',
    files: ['base.py', 'openai_compat.py', 'profiles.py'],
    exports: [
      { name: 'ModelBackend', kind: 'class' },
      { name: 'ModelProfile', kind: 'class' },
      { name: 'create_ollama_backend', kind: 'func' },
      { name: 'create_vllm_backend', kind: 'func' },
      { name: 'create_lmstudio_backend', kind: 'func' },
      { name: 'get_profile', kind: 'func' },
      { name: 'register_profile', kind: 'func' },
    ],
    deps: ['errors'],
  },
  {
    id: 'observability', label: 'Observability', subtitle: 'observability/',
    category: 'observability', x: 740, y: 370, w: 160, h: 56,
    description: 'Structured logging with sensitive data filtering. Experimental tracing and OpenTelemetry integration.',
    files: ['logging.py', 'tracing.py', 'otel.py'],
    exports: [
      { name: 'AgentLogger', kind: 'class' },
      { name: 'SensitiveDataFilter', kind: 'class' },
      { name: 'StructuredFormatter', kind: 'class' },
      { name: 'setup_logging', kind: 'func' },
      { name: 'RequestTracer', kind: 'class' },
      { name: 'OTelIntegration', kind: 'class' },
    ],
    deps: [],
  },
  {
    id: '_internal', label: '_internal', subtitle: '_internal/',
    category: 'private', x: 1010, y: 370, w: 150, h: 56,
    description: 'Private internal utilities. Not part of the public API.',
    files: ['__init__.py'],
    exports: [],
    deps: [],
  },
];

const connections = [
  // Agent imports
  { from: 'agent', to: 'config',   type: 'imports',    label: 'settings' },
  { from: 'agent', to: 'context',  type: 'integrates', label: 'context mgmt' },
  { from: 'agent', to: 'tokens',   type: 'integrates', label: 'usage tracking' },
  { from: 'agent', to: 'prompts',  type: 'integrates', label: 'templates' },
  { from: 'agent', to: 'errors',   type: 'imports',    label: 'exceptions' },
  { from: 'agent', to: 'tools',    type: 'uses',       label: 'tool registry' },
  { from: 'agent', to: 'mcp',      type: 'uses',       label: 'toolsets' },

  // Config aggregates
  { from: 'config', to: 'context',  type: 'configures', label: 'CompactionConfig' },
  { from: 'config', to: 'tokens',   type: 'configures', label: 'TokenizerConfig' },
  { from: 'config', to: 'prompts',  type: 'configures', label: 'PromptConfig' },

  // Context uses tokens
  { from: 'context', to: 'tokens',  type: 'uses', label: 'counting' },

  // Workflows
  { from: 'workflows', to: 'agent',   type: 'uses',    label: 'executes' },
  { from: 'workflows', to: 'prompts', type: 'uses',    label: 'iteration prompt' },

  // Errors
  { from: 'errors',   to: 'config',   type: 'imports', label: 'recovery config' },
  { from: 'backends', to: 'errors',   type: 'imports', label: 'exceptions' },
];

// ═══════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════

const DEFAULTS = {
  view: 'graph',
  preset: 'full',
  layers: Object.fromEntries(Object.keys(CATEGORIES).map(k => [k, true])),
  connTypes: Object.fromEntries(Object.keys(CONN_TYPES).map(k => [k, true])),
  selectedModule: null,
  searchQuery: '',
  comments: [],
  zoom: 1,
  panX: 0,
  panY: 0,
};

const state = JSON.parse(JSON.stringify(DEFAULTS));

// ═══════════════════════════════════════════════
// PRESETS
// ═══════════════════════════════════════════════

const PRESETS = {
  full: {
    layers: Object.fromEntries(Object.keys(CATEGORIES).map(k => [k, true])),
    connTypes: Object.fromEntries(Object.keys(CONN_TYPES).map(k => [k, true])),
  },
  core: {
    layers: { core: true, infrastructure: false, tools: false, orchestration: true, integration: false, observability: false, private: false },
    connTypes: { imports: false, integrates: true, configures: false, uses: true, extends: true },
  },
  infra: {
    layers: { core: false, infrastructure: true, tools: true, orchestration: false, integration: true, observability: true, private: false },
    connTypes: Object.fromEntries(Object.keys(CONN_TYPES).map(k => [k, true])),
  },
  agent: {
    layers: { core: true, infrastructure: true, tools: true, orchestration: false, integration: true, observability: false, private: false },
    connTypes: { imports: true, integrates: true, configures: true, uses: true, extends: false },
  },
};

// ═══════════════════════════════════════════════
// RENDER CONTROLS
// ═══════════════════════════════════════════════

function renderLayerToggles() {
  const el = document.getElementById('layer-toggles');
  el.innerHTML = Object.entries(CATEGORIES).map(([key, cat]) => `
    <label class="layer-toggle">
      <input type="checkbox" data-layer="${key}" ${state.layers[key] ? 'checked' : ''}>
      <span class="check-box"></span>
      <span class="layer-dot" style="background:${cat.color}"></span>
      <span>${cat.label}</span>
    </label>
  `).join('');
  el.querySelectorAll('input').forEach(cb => {
    cb.addEventListener('change', () => {
      state.layers[cb.dataset.layer] = cb.checked;
      clearPresetActive();
      updateAll();
    });
  });
}

function renderConnToggles() {
  const el = document.getElementById('conn-toggles');
  el.innerHTML = Object.entries(CONN_TYPES).map(([key, ct]) => `
    <label class="conn-type">
      <input type="checkbox" data-conn="${key}" ${state.connTypes[key] ? 'checked' : ''}>
      <span class="check-box"></span>
      <span class="conn-line ${ct.dash ? 'dashed' : ''}" style="color:${ct.color};background:${ct.dash ? '' : ct.color}"></span>
      <span>${ct.label}</span>
    </label>
  `).join('');
  el.querySelectorAll('input').forEach(cb => {
    cb.addEventListener('change', () => {
      state.connTypes[cb.dataset.conn] = cb.checked;
      clearPresetActive();
      updateAll();
    });
  });
}

function clearPresetActive() {
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
}

// ═══════════════════════════════════════════════
// SVG RENDERING
// ═══════════════════════════════════════════════

const svgEl = document.getElementById('svg');
let isPanning = false, startPanX, startPanY;

function getVisibleModules() {
  return modules.filter(m => state.layers[m.category]);
}

function getVisibleConnections() {
  const visIds = new Set(getVisibleModules().map(m => m.id));
  return connections.filter(c =>
    state.connTypes[c.type] && visIds.has(c.from) && visIds.has(c.to)
  );
}

function getSearchMatches() {
  const q = state.searchQuery.toLowerCase().trim();
  if (!q) return new Set();
  const matches = new Set();
  modules.forEach(m => {
    if (m.label.toLowerCase().includes(q) || m.id.toLowerCase().includes(q) ||
        m.description.toLowerCase().includes(q) ||
        m.files.some(f => f.toLowerCase().includes(q)) ||
        m.exports.some(e => e.name.toLowerCase().includes(q))) {
      matches.add(m.id);
    }
  });
  return matches;
}

function renderSVG() {
  const vis = getVisibleModules();
  const conns = getVisibleConnections();
  const matches = getSearchMatches();
  const commentedIds = new Set(state.comments.map(c => c.target));

  // Defs
  let defs = '<defs>';
  Object.entries(CONN_TYPES).forEach(([key, ct]) => {
    defs += `<marker id="arrow-${key}" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="${ct.color}"/>
    </marker>`;
  });
  defs += '</defs>';

  // Connections
  let paths = '';
  conns.forEach(c => {
    const from = modules.find(m => m.id === c.from);
    const to = modules.find(m => m.id === c.to);
    if (!from || !to) return;

    const x1 = from.x + from.w / 2, y1 = from.y + from.h / 2;
    const x2 = to.x + to.w / 2, y2 = to.y + to.h / 2;

    // Find edge intersection points
    const pts = getEdgePoints(from, to);
    const ct = CONN_TYPES[c.type];
    const midX = (pts.x1 + pts.x2) / 2;
    const midY = (pts.y1 + pts.y2) / 2;
    const dx = pts.x2 - pts.x1, dy = pts.y2 - pts.y1;
    const cx = midX + dy * 0.15, cy = midY - dx * 0.15;

    const isHighlight = state.selectedModule && (c.from === state.selectedModule || c.to === state.selectedModule);

    paths += `<path class="conn-path${isHighlight ? ' highlight' : ''}" d="M${pts.x1},${pts.y1} Q${cx},${cy} ${pts.x2},${pts.y2}"
      stroke="${ct.color}" stroke-dasharray="${ct.dash}" marker-end="url(#arrow-${c.type})"
      opacity="${isHighlight ? 1 : 0.4}"/>`;

    if (c.label && isHighlight) {
      const lx = (pts.x1 + 2*cx + pts.x2) / 4;
      const ly = (pts.y1 + 2*cy + pts.y2) / 4;
      paths += `<text x="${lx}" y="${ly - 6}" text-anchor="middle" font-size="9" fill="${ct.color}" font-family="-apple-system,system-ui,sans-serif">${c.label}</text>`;
    }
  });

  // Nodes
  let nodes = '';
  vis.forEach(m => {
    const cat = CATEGORIES[m.category];
    const isSelected = state.selectedModule === m.id;
    const isMatch = matches.has(m.id);
    const isCommented = commentedIds.has(m.id);
    const strokeColor = isSelected ? '#fff' : (isMatch ? '#fbbf24' : cat.color);
    const strokeWidth = isSelected || isMatch ? 2.5 : 1.5;

    nodes += `<g class="node-group" data-id="${m.id}" transform="translate(${m.x},${m.y})">
      <rect class="node-rect${isSelected ? ' selected' : ''}${isMatch ? ' search-match' : ''}"
        width="${m.w}" height="${m.h}" rx="8" ry="8"
        fill="${cat.bg}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>
      ${isCommented ? `<circle cx="${m.w - 8}" cy="8" r="5" fill="#f472b6"/>` : ''}
      <text class="node-label" x="${m.w/2}" y="${m.h/2 - 6}" text-anchor="middle"
        font-size="13" font-weight="600" fill="${cat.color}" font-family="-apple-system,system-ui,sans-serif">${m.label}</text>
      <text class="node-sub" x="${m.w/2}" y="${m.h/2 + 10}" text-anchor="middle"
        font-size="10" fill="#8b90a0" font-family="'SF Mono','Fira Code',monospace">${m.subtitle}</text>
    </g>`;
  });

  const transform = `translate(${state.panX},${state.panY}) scale(${state.zoom})`;
  svgEl.innerHTML = `${defs}<g id="svg-root" transform="${transform}">${paths}${nodes}</g>`;

  // Click handlers
  svgEl.querySelectorAll('.node-group').forEach(g => {
    g.addEventListener('click', (e) => {
      e.stopPropagation();
      selectModule(g.dataset.id);
    });
  });

  // Stats
  document.getElementById('stat-modules').textContent = vis.length;
  document.getElementById('stat-conns').textContent = conns.length;
}

function getEdgePoints(from, to) {
  const cx1 = from.x + from.w / 2, cy1 = from.y + from.h / 2;
  const cx2 = to.x + to.w / 2, cy2 = to.y + to.h / 2;
  const dx = cx2 - cx1, dy = cy2 - cy1;
  const angle = Math.atan2(dy, dx);

  function edgePoint(m, ang, outgoing) {
    const hw = m.w / 2, hh = m.h / 2;
    const a = outgoing ? ang : ang + Math.PI;
    const cos = Math.cos(a), sin = Math.sin(a);
    const scaleX = cos !== 0 ? Math.abs(hw / cos) : Infinity;
    const scaleY = sin !== 0 ? Math.abs(hh / sin) : Infinity;
    const s = Math.min(scaleX, scaleY);
    return { x: m.x + hw + cos * s, y: m.y + hh + sin * s };
  }

  const p1 = edgePoint(from, angle, true);
  const p2 = edgePoint(to, angle, false);
  return { x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y };
}

// ═══════════════════════════════════════════════
// DETAIL PANEL
// ═══════════════════════════════════════════════

function selectModule(id) {
  if (state.selectedModule === id) {
    state.selectedModule = null;
    document.getElementById('detail-panel').classList.remove('open');
    updateAll();
    return;
  }

  state.selectedModule = id;
  const m = modules.find(mod => mod.id === id);
  if (!m) return;

  const cat = CATEGORIES[m.category];
  document.getElementById('detail-title').innerHTML =
    `<span style="color:${cat.color}">${m.label}</span> <span style="font-weight:400;font-size:12px;color:var(--text-dim)">${cat.label}</span>`;

  const body = document.getElementById('detail-body');
  body.innerHTML = `
    <p class="meta">src/mamba_agents/${m.subtitle}</p>
    <p class="desc">${m.description}</p>

    <div class="detail-section">
      <h4>Files (${m.files.length})</h4>
      ${m.files.map(f => `<div class="detail-item"><span class="kind kind-file">file</span>${f}</div>`).join('')}
    </div>

    ${m.exports.length ? `<div class="detail-section">
      <h4>Key Exports (${m.exports.length})</h4>
      ${m.exports.map(e => `<div class="detail-item"><span class="kind kind-${e.kind}">${e.kind}</span>${e.name}</div>`).join('')}
    </div>` : ''}

    ${m.deps.length ? `<div class="detail-section">
      <h4>Dependencies (${m.deps.length})</h4>
      <div style="display:flex;flex-wrap:wrap">
        ${m.deps.map(d => {
          const dep = modules.find(mod => mod.id === d);
          const dc = dep ? CATEGORIES[dep.category] : null;
          return `<span class="dep-link" data-dep="${d}" style="border-left:3px solid ${dc ? dc.color : '#666'}">${d}</span>`;
        }).join('')}
      </div>
    </div>` : ''}
  `;

  body.querySelectorAll('.dep-link').forEach(el => {
    el.addEventListener('click', () => selectModule(el.dataset.dep));
  });

  document.getElementById('detail-panel').classList.add('open');
  document.getElementById('comment-text').value = '';
  updateAll();
}

document.getElementById('detail-close').addEventListener('click', () => {
  state.selectedModule = null;
  document.getElementById('detail-panel').classList.remove('open');
  updateAll();
});

// ═══════════════════════════════════════════════
// COMMENTS
// ═══════════════════════════════════════════════

document.getElementById('comment-add').addEventListener('click', () => {
  const text = document.getElementById('comment-text').value.trim();
  if (!text || !state.selectedModule) return;
  const m = modules.find(mod => mod.id === state.selectedModule);
  state.comments.push({
    id: Date.now(),
    target: m.id,
    targetLabel: m.label,
    targetFile: `src/mamba_agents/${m.subtitle}`,
    text,
  });
  document.getElementById('comment-text').value = '';
  updateAll();
});

function renderComments() {
  const el = document.getElementById('comments-list');
  document.getElementById('comment-count').textContent = `(${state.comments.length})`;
  if (!state.comments.length) {
    el.innerHTML = '<div class="no-comments">Click a module to add feedback</div>';
    return;
  }
  el.innerHTML = state.comments.map(c => `
    <div class="comment-entry">
      <button class="ce-del" data-cid="${c.id}">&times;</button>
      <div class="ce-target">${c.targetLabel}</div>
      <div class="ce-text">${escHtml(c.text)}</div>
    </div>
  `).join('');
  el.querySelectorAll('.ce-del').forEach(btn => {
    btn.addEventListener('click', () => {
      state.comments = state.comments.filter(c => c.id !== +btn.dataset.cid);
      updateAll();
    });
  });
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ═══════════════════════════════════════════════
// LIST VIEW
// ═══════════════════════════════════════════════

function renderListView() {
  const vis = getVisibleModules();
  const matches = getSearchMatches();
  const el = document.getElementById('list-view');

  const filtered = state.searchQuery ? vis.filter(m => matches.has(m.id)) : vis;

  el.innerHTML = filtered.map(m => {
    const cat = CATEGORIES[m.category];
    return `<div class="list-module" data-id="${m.id}">
      <div class="list-module-header">
        <span class="lm-dot" style="background:${cat.color}"></span>
        <span class="lm-name">${m.label}</span>
        <span class="lm-cat">${cat.label}</span>
      </div>
      <div class="list-module-body" id="lm-body-${m.id}">
        <p class="lm-desc">${m.description}</p>
        <div class="lm-files">${m.files.map(f => `<span class="lm-file">${f}</span>`).join('')}</div>
        ${m.exports.length ? `<div class="lm-exports">
          ${m.exports.map(e => `<div class="lm-export-item"><span class="kind kind-${e.kind}">${e.kind}</span>${e.name}</div>`).join('')}
        </div>` : ''}
        ${m.deps.length ? `<div style="margin-top:10px"><strong style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px">Dependencies:</strong>
          <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px">
            ${m.deps.map(d => {
              const dep = modules.find(mod => mod.id === d);
              const dc = dep ? CATEGORIES[dep.category] : null;
              return `<span class="dep-link" style="border-left:3px solid ${dc ? dc.color : '#666'}">${d}</span>`;
            }).join('')}
          </div>
        </div>` : ''}
      </div>
    </div>`;
  }).join('');

  el.querySelectorAll('.list-module-header').forEach(h => {
    h.addEventListener('click', () => {
      const body = h.nextElementSibling;
      body.classList.toggle('open');
    });
  });
}

// ═══════════════════════════════════════════════
// PROMPT
// ═══════════════════════════════════════════════

function updatePrompt() {
  const parts = [];
  const vis = getVisibleModules();
  const allVisible = Object.values(state.layers).every(v => v);

  if (!allVisible) {
    const active = Object.entries(state.layers).filter(([,v]) => v).map(([k]) => CATEGORIES[k].label);
    parts.push(`Focusing on the ${active.join(', ')} layer${active.length > 1 ? 's' : ''} of the Mamba Agents architecture.`);
  } else {
    parts.push('This is the full Mamba Agents architecture.');
  }

  if (state.selectedModule) {
    const m = modules.find(mod => mod.id === state.selectedModule);
    if (m) {
      parts.push(`\nCurrently inspecting: **${m.label}** (src/mamba_agents/${m.subtitle})`);
      if (m.deps.length) {
        parts.push(`Dependencies: ${m.deps.join(', ')}`);
      }
    }
  }

  if (state.comments.length) {
    parts.push('\nFeedback on specific modules:\n');
    state.comments.forEach(c => {
      parts.push(`**${c.targetLabel}** (${c.targetFile}):\n${c.text}\n`);
    });
  }

  document.getElementById('prompt-text').textContent = parts.join('\n');
}

// ═══════════════════════════════════════════════
// VIEW SWITCHING
// ═══════════════════════════════════════════════

document.querySelectorAll('.view-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    state.view = tab.dataset.view;

    const canvasWrap = document.getElementById('canvas-wrap');
    const listView = document.getElementById('list-view');

    if (state.view === 'graph') {
      canvasWrap.classList.remove('hidden');
      listView.classList.remove('active');
    } else {
      canvasWrap.classList.add('hidden');
      listView.classList.add('active');
    }
    updateAll();
  });
});

// ═══════════════════════════════════════════════
// PRESETS
// ═══════════════════════════════════════════════

document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const preset = PRESETS[btn.dataset.preset];
    Object.assign(state.layers, preset.layers);
    Object.assign(state.connTypes, preset.connTypes);
    renderLayerToggles();
    renderConnToggles();
    updateAll();
  });
});

// ═══════════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════════

document.getElementById('search').addEventListener('input', (e) => {
  state.searchQuery = e.target.value;
  updateAll();
});

// ═══════════════════════════════════════════════
// ZOOM & PAN
// ═══════════════════════════════════════════════

document.getElementById('zoom-in').addEventListener('click', () => {
  state.zoom = Math.min(state.zoom * 1.2, 3);
  updateAll();
});
document.getElementById('zoom-out').addEventListener('click', () => {
  state.zoom = Math.max(state.zoom / 1.2, 0.3);
  updateAll();
});
document.getElementById('zoom-reset').addEventListener('click', () => {
  fitToView();
  updateAll();
});

function fitToView() {
  const vis = getVisibleModules();
  if (!vis.length) return;
  const wrap = document.getElementById('canvas-wrap');
  const W = wrap.clientWidth - 60;
  const H = wrap.clientHeight - 60;
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  vis.forEach(m => {
    minX = Math.min(minX, m.x);
    minY = Math.min(minY, m.y);
    maxX = Math.max(maxX, m.x + m.w);
    maxY = Math.max(maxY, m.y + m.h);
  });
  const dw = maxX - minX, dh = maxY - minY;
  state.zoom = Math.min(W / dw, H / dh, 1.5);
  state.panX = (W - dw * state.zoom) / 2 - minX * state.zoom + 30;
  state.panY = (H - dh * state.zoom) / 2 - minY * state.zoom + 30;
}

// SVG pan
svgEl.addEventListener('mousedown', (e) => {
  if (e.target.closest('.node-group')) return;
  isPanning = true;
  startPanX = e.clientX - state.panX;
  startPanY = e.clientY - state.panY;
});
window.addEventListener('mousemove', (e) => {
  if (!isPanning) return;
  state.panX = e.clientX - startPanX;
  state.panY = e.clientY - startPanY;
  const root = document.getElementById('svg-root');
  if (root) root.setAttribute('transform', `translate(${state.panX},${state.panY}) scale(${state.zoom})`);
});
window.addEventListener('mouseup', () => { isPanning = false; });

svgEl.addEventListener('wheel', (e) => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.92 : 1.08;
  const newZoom = Math.min(Math.max(state.zoom * delta, 0.3), 3);

  const rect = svgEl.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  state.panX = mx - (mx - state.panX) * (newZoom / state.zoom);
  state.panY = my - (my - state.panY) * (newZoom / state.zoom);
  state.zoom = newZoom;

  const root = document.getElementById('svg-root');
  if (root) root.setAttribute('transform', `translate(${state.panX},${state.panY}) scale(${state.zoom})`);
}, { passive: false });

// Click background to deselect
svgEl.addEventListener('click', (e) => {
  if (!e.target.closest('.node-group')) {
    state.selectedModule = null;
    document.getElementById('detail-panel').classList.remove('open');
    updateAll();
  }
});

// ═══════════════════════════════════════════════
// COPY
// ═══════════════════════════════════════════════

document.getElementById('copy-btn').addEventListener('click', () => {
  const text = document.getElementById('prompt-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
  });
});

// ═══════════════════════════════════════════════
// MAIN UPDATE
// ═══════════════════════════════════════════════

function updateAll() {
  renderSVG();
  renderComments();
  renderListView();
  updatePrompt();
}

// ═══════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════

renderLayerToggles();
renderConnToggles();
fitToView();
updateAll();
</script>
</body>
</html>
